<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Directory Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Professional autofill styling */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px #f8f9fa inset !important;
      -webkit-text-fill-color: #495057 !important;
      font-family: ui-sans-serif, system-ui, sans-serif !important;
      transition: background-color 5000s ease-in-out 0s;
      caret-color: #495057 !important;
    }
    input:-webkit-autofill:focus {
      -webkit-text-fill-color: #212529 !important;
      caret-color: #0066cc !important;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800 p-6 font-sans">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
      <h1 class="text-3xl font-bold text-gray-800">
        Employee Directory
      </h1>
      <a href="/logout" class="px-4 py-2 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 transition duration-200">
        Sign Out
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Search Name Form -->
      <form id="search-form" method="post" action="/search"
            class="lg:col-span-2 bg-white border border-gray-300 rounded-lg p-6 shadow-sm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2 font-medium">Search Employee</label>
          <input type="text" name="term" placeholder="Enter employee name"
                 class="w-full p-3 rounded-md border border-gray-300 text-gray-700 placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200">
        </div>
        <button type="submit"
                class="w-full py-3 rounded-md bg-blue-600 text-white font-medium hover:bg-blue-700 transition duration-200">
          Search Directory
        </button>
      </form>

      <!-- Admin Access Form -->
      <form id="passcode-form" method="post" action="/admin-login"
            class="bg-white border border-gray-300 rounded-lg p-6 shadow-sm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-2 font-medium">Admin Access</label>
          <input type="password" name="passcode" placeholder="Enter admin passcode"
                 class="w-full p-3 rounded-md border border-gray-300 text-gray-700 placeholder-gray-400 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200">
        </div>
        <button type="submit"
                class="w-full py-3 rounded-md bg-green-600 text-white font-medium hover:bg-green-700 transition duration-200">
          Admin Login
        </button>
      </form>
    </div>

    {% if message %}
      <div class="mb-6 p-3 rounded-md border border-red-300 bg-red-50 text-red-700 text-center">
        {{ message }}
      </div>
    {% endif %}

    {% if results %}
      <div class="bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-gray-800">Search Results</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for row in results %}
                <tr class="hover:bg-gray-50 transition duration-150">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ row[0] }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ row[1] }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row[2] }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ row[3] }}</td>
                  <td class="px-6 py-4 text-sm text-gray-500">{{ row[4] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="bg-white border border-gray-300 rounded-lg p-8 text-center">
        <p class="text-gray-500">Use the search form above to find employees in the directory.</p>
      </div>
    {% endif %}
  </div>

  <script>
    document.getElementById('search-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const formData = new FormData(form);
      
      const res = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      
      if (res.ok) {
        const html = await res.text();
        document.open();
        document.write(html);
        document.close();
      } else if (res.status === 401) {
        alert('Session expired. Redirecting to login.');
        window.location.href = '/';
      } else {
        alert('Search failed.');
      }
    });

    document.getElementById('passcode-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const formData = new FormData(form);

      const existingError = form.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
          },
          body: formData
        });

        if (res.ok) {
          const json = await res.json();
          
          if (json.success && json.redirect) {
            window.location.href = json.redirect;
          } else {
            showError(form, 'Login failed');
          }
        } else {
          const errorText = await res.text();
          console.log('Passcode error:', errorText);
          showError(form, 'Invalid passcode');
        }
      } catch (error) {
        console.error('Passcode submission error:', error);
        showError(form, 'Passcode submission failed');
      }
    });

    function showError(form, message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message mt-3 p-2 rounded border border-red-300 bg-red-50 text-red-700 text-center text-sm';
      errorDiv.textContent = message;
      
      form.appendChild(errorDiv);
      
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 4000);
    }
  </script>
</body>
</html>